---
# Secrets Manager setup only
# Usage: ansible-playbook playbooks/03-secrets-manager.yml --ask-vault-pass
# Note: Requires rds_endpoint and redis_endpoint to be set

- name: Setup AWS Secrets Manager for Drop Backend
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../group_vars/all.yml
    - ../group_vars/secrets.yml

  pre_tasks:
    - name: Get RDS endpoint
      ansible.builtin.command:
        cmd: >
          aws rds describe-db-instances
          --db-instance-identifier {{ rds_instance_identifier }}
          --region {{ aws_region }}
          --query 'DBInstances[0].Endpoint.Address'
          --output text
      register: rds_endpoint_result
      changed_when: false

    - name: Get Redis endpoint
      ansible.builtin.command:
        cmd: >
          aws elasticache describe-cache-clusters
          --cache-cluster-id {{ redis_cluster_id }}
          --show-cache-node-info
          --region {{ aws_region }}
          --query 'CacheClusters[0].CacheNodes[0].Endpoint.Address'
          --output text
      register: redis_endpoint_result
      changed_when: false

    - name: Set endpoint facts
      ansible.builtin.set_fact:
        rds_endpoint: "{{ rds_endpoint_result.stdout }}"
        redis_endpoint: "{{ redis_endpoint_result.stdout }}"

  roles:
    - role: secrets-manager
